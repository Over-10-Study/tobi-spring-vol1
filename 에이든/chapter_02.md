# Chapter 02 - 테스트

## 2.1 USER DAO TEST 다시보기
## 2.2 USER DAO TEST 개선
## 2.3 개발자를 위한 테스팅 프레임워크 JUNIT
* 반복적으로 테스트를 했을 때 테스트가 실패하기도 하고 성공하기도 한다면 이는 좋은 테스트라고 할 수 가 없다. 코드에 변경사항이 없다면 테스트는 항상 동일한 결과를 내야 한다.
* 테스트하기 전에 테스트 실행에 문제가 되지 않는 상태를 만들어주는 것이 더 좋다.
* 테스트는 실행하는 순서를 바꿔도 동일한 결과가 보장되도록 만들어야 한다.
* 항상 네거티브 테스를 먼저 만들어라.
* 조건 -> 행위 -> 결과 가 잘 표현된 코드인지 확인 해보자.
	* 어떤 조건을 가지고?
	* 무엇을 할 때?
	* 어떤 결과가 나올까?
* TDD 에서는 테스트 작성하고 이를 성공시키는 코드를 만드는 작업의 주기를 가능한 짧게 가져가도록 권장한다.
* 테스트를 먼저 만들어두고 코딩이 끝나자마자 바로 실행 할 수 있으니 가장 좋은 방법이다.
* 차선은 일정 분량의 코딩을 먼저 해놓고 빠른 시간 안에 테스트 코드를 만들어 테스트해도 상관없다.
* 테스트 코드도 언제든지 내부구조와 설계를 개선해서 좀더 **깔끔하고 이해하기 쉽고**, **변경하기 쉬운 코드**를 만들 필요가 있다.
* JUnit이 하나의 테스트 클래스를 가져와 테스트를 수행하는 방식은 다음과 같다.
	* @Test가 붙고 Public이고 void형이며 파라미터가 없는 테스트 메소드를 모두 찾는다.
	* 테스트 클래스의 오브젝트를 하나 만든다.
	* @Before 가 붙은 메소드가 있으면 실행한다.
	* @Test가 붙은 메소드를 하나 호출하고 테스트 결과를 저장해둔다.
	* @After가 붙은 메소드가 있으면 실행한다.
	* 나머지 테스트 메소드에 대한 2~5번을 반복한다.
	* 모든 테스트의 결과를 종합해서 돌려준다.
	> 각 테스트가 서로 영향을 주지 않고 독립적으로 실행됨을 확실히 보장해주기 위해서 매번 새로운 오브젝트를 만들게 했다.
	
## 2.4 스프링 테스트 적용

* 애플리케이션 컨텍스트처럼 생성에 많은 시간과 자원이 소모되는 경우에는 테스트 전체가 공유하는 오브젝트를 만들기도 한다.
```java
// 스프링 테스트 컨텍스트를 적용한 UserDaoTest
@RunWith(SpringJUnit4ClassRunner.class) // 스프링의 테스트 컨텍스트 프레임워크의 JUnit 확장기능 지정
@ContextConfiguration(locations="/applicationContext.xml") // 테스트 컨텍스트가 자동으로 만들어줄 애플리케이션 컨텍스트 위치 지정
public class UserDaoTest {
	@Autowired
	private ApplicationContext context; // 테스트 오브젝트가 만들어지고 나면 스프링 테스트 컨텍스트에 의해 자동으로 값이 주입된다.
	...
	
	@Before
	public void setUp() {
		this.dao = this.context.getBean("userDao", UserDao.class);
		...
	}
}
```
> context는 세번 모두 동일하다. 따라서 하나의 애플리케이션 컨텍스트가 만들어져 모든 테스트 메소드에서 사용되고 있음을 알 수 있다.
> UserDaoTest의 오브젝트는 매번 주소 값이 다르다. 앞에서 설명한 것처럼 JUnit은 테스트 메소드를 실행할 때마다 새로운 테스트 오브젝트를 만든다.

* @Autowired
	* 변수 타입과 일치하는 컨텍스트 내의 빈을 찾는다.
	* 스프링 애플리케이션 컨텍스트는 초기화할 때 자기 자신도 빈으로 등록한다.
	* 변수에 할당 가능한 타입을 가진 빈을 자동으로 찾는다.
	* 같은 타입의 빈이 두 개 이상 있는 경우에는 타입만으로 어떤 빈을 가져올지 결정할 수 없다.
	* 타입으로 가져올 **빈하나를 선택할 수 없는 경우에는 변수의 이름과 같은 이름의 빈이 있는지 확인한다.**
* 테스트는 필요하다면 얼마든지 애플리케이션 클래스와 밀접한 관계를 맺고 있어도 상관 없다.
	* 개발자가 만드는 테스트는 코드 내부구조와 설정 등을 알고 있고 의도적으로 그 내용을 검증해야 할 필요가 있다.
	* 그래도... 테스트에서도 가능한 한 인터페이스를 사용해서 애플리케이션 코드와 느슨하게 연결해두는편이 좋다.
* 그런데... 굳이 인터페이스를 사용하고 DI를 통해 주앱해주는 방식을 이용해야 하는가?
	* 소프트웨어 개발에서 절대로 바뀌지 않는 것은 없기 때문이다.
		* new 대신 DI를 통해 주입받게 하는건 아주 단순하고 쉬운 작업이다.
		* 클래스의 변경이 필요한 상황이 닥쳤을 때 수정에 들어가는 시간과 비용의 부담을 줄여줄 수 있다.
	* 클래스의 구현방식은 바뀌지 않는다고 하더라도 인터페이스를 두고  DI를 적용하게 해두면 다른 차원의 서비스 기능을 도입할 수 있기 때문이다.
		* DB 커넥션의 개수를 카운팅하는 부가기능 등..
	* 효율적인 테스트를 손쉽게 만들기 위해서라도 DI를 적용해야한다.
* @DirtiesContext
	* 테스트 메소드에서 애플리케이션 컨텍스트의 구성이나 상태를 변경한다는 것을 테스트 컨텍스트 프레임워크에 알려준다.
		* 이 애노테이션이 붙은 테스트 클래스에는 애플리케이션 컨텍스트 공유를 허용하지 않는다.
* DI
	* 객체지향 프로그래밍 스타일이다.
	* DI를 위해 컨테이너가 반드시 필요한 것은 아니다.
	* DI 컨테이너나 프레임 워크는 DI를 편하게 적용하도록 도움을 줄 뿐, 컨테이너가 DI를 가능하게 해주는 것은 아니다.
	> 침투적 기술과 비침투적 기술
	> * 침투적 기술은 기술을 적용했을 때 애플리케이션 코드가 해당 기술에 족속되는 결과를 가져온다.
	> * 비침투적인 기술은 애플리케이션 로직을 담은 코드에 아무런 영향을 주지 않고 적용이 가능하다. 즉, 기술에 종속적이지 않은 순수한 코드를 유지할 수 있게 해준다.
```java
// 애플리케이션 컨텍스트가 없는 DI 테스트
// DI 컨테이너나 프레임 워크는 DI를 편하게 적용하도록 도움을 줄 뿐, 컨테이너가 DI를 가능하게 해주는 것은 아니다.
public class UserDaoTest {
	UserDao dao;

	@Before
	public void setUp() {
		...
		// 오브젝트 생성, 관계설정 등을 모두 직접 해준다.
		dao = new UserDao();
		DataSource dataSource = new SingleConnectionDataSource("jdbc:mysql://localhost/testdb", "spring", "book", true);
		dao.setDataSource(dataSource)
	}
}
```

## 2.5 학습 테스트로 배우는 스프링

* 학습테스트
	* 사용할 API나 프레임워크의 기능을 테스트로 보면서 사용방법을 익히려는 것이다.
	* 프레임워크나 기능에 대한 검증이 목적이 아니다.
* 학습테스트의 장점
	* 다양한 조건에 따른 기능을 손쉽게 확인해볼 수 있다.
	* 학습 테스트 코드를 개발 중에 참고할 수 있다.
	* 프레임워크나 제품을 업그레이드할 때 호환성 검증을 도와준다.
	* 테스트 작성에 대한 좋은 훈련이 된다.
	* 새로운 기술을 공부하는 과정이 즐거워진다.

## 2.6 정리
* 테스트는 자동화 돼야한다.
* 테스트 결과는 일관성이 있어야 한다. 코드의 변경 없이 환경이나 테스트 실행 순서에 따라서 결과가 달라지면 안된다.
* 테스트는 포괄적으로 작성해야 한다. 충분한 검증을 하지 않는 테스트는 없는 것보다 나쁠 수 있다.
* **코드 작성과 테스트 수행의 간격이 짧을수록 효과적이다.**
* 테스트하기 쉬운 코드가 좋은 코드다.
* 테스트를 먼저 만들고 테스트를 성공시키는 코드를 만들어가는 테스트 주도 개발 방법도 유용하다.
* 테스트 코드도 애플리케이션 코드와 마찬가지로 적절한 리팩토링이 필요하다.
* @Before, @After를 사용해서 테스트 메소드들의 공통 준비 작업과 정리 작업을 처리할 수 있다.
* 스프링 테스트 컨텍스트 프레임 워크를 이용하면 하나의 애플리케이션 컨텍스트를 공유한다.
* @Autowired를 사용하면 컨텍스트의 빈을 테스트 오브젝트에 DI 할 수 있다.
* 기술의 사용방법을 익히고 이해를 돕기 위해 학습테스트를 작성하자.
* 오류가 발견될 경우 그에 대한 버그 테스트를 만들어두면 유용하다.
* 스프링을 사용하는 개발자라면 자신이 만든 코드를 테스트로 검증하는 방법을 알고, 테스트를 개발에 적극적으로 활용할 수 있어야 한다.
